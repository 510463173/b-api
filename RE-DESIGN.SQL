SET
  FOREIGN_KEY_CHECKS = 0;

DROP TABLE IF EXISTS `ROLE`;

CREATE TABLE `ROLE` (
  `ID` INT(11) NOT NULL AUTO_INCREMENT COMMENT 'ID',
  `NAME` VARCHAR(20) NOT NULL COMMENT 'role name',
  `DESCRIPTION` VARCHAR(200) NULL COMMENT 'authority description',
  PRIMARY KEY (`ID`)
)
ENGINE = InnoDB
AUTO_INCREMENT = 1
CHARSET = utf8
COMMENT = 'ROLE';

DROP TABLE IF EXISTS `USER`;

CREATE TABLE `USER` (
  `ID` INT(11) NOT NULL AUTO_INCREMENT COMMENT 'ID',
  `USER_NAME` VARCHAR(20) NOT NULL COMMENT 'user name',
  `ENCRYPTED_PASSWORD` VARCHAR(200) NOT NULL COMMENT 'encrypted password',
  `ROLE` INT(11) NOT NULL COMMENT 'user role',
  `PHONE` VARCHAR(20) NULL COMMENT 'phone number',
  `GENDER` VARCHAR(1) NULL COMMENT 'gender',
  `EMAIL` VARCHAR(200) NOT NULL COMMENT 'email address',
  `ADDRESS` VARCHAR(20) NULL COMMENT 'address',
  `PORTRAIT` VARCHAR(200) NULL COMMENT 'user head picture',
  `REGISTERED_WHEN` DATETIME NOT NULL COMMENT 'when did the user registered',
  `LAST_LOGIN` DATETIME NULL COMMENT 'the time of last login',
  `STATUS` VARCHAR(10) NOT NULL DEFAULT 'ACTIVE' COMMENT 'user status, ACTIVE/LOCK/INACTIVE',
  PRIMARY KEY (`ID`),
  CONSTRAINT FK_ROLE FOREIGN KEY (`ROLE`) references ROLE(`ID`)
)
ENGINE = InnoDB
AUTO_INCREMENT = 1
CHARSET = utf8
COMMENT = 'USER';

DROP TABLE IF EXISTS `CATEGORY`;

CREATE TABLE `CATEGORY` (
  `ID` INT(11) NOT NULL AUTO_INCREMENT COMMENT 'ID',
  `NAME` VARCHAR(250) NOT NULL COMMENT 'category name',
  `DESCRIPTION` TEXT NOT NULL COMMENT 'category description',
  PRIMARY KEY (`ID`)
)
ENGINE = InnoDB
AUTO_INCREMENT = 1
CHARSET = utf8
COMMENT = 'CATEGORY';

DROP TABLE IF EXISTS `ARTICLE`;

CREATE TABLE `ARTICLE` (
  `ID` INT(11) NOT NULL AUTO_INCREMENT COMMENT 'ID',
  `TITLE` VARCHAR(250) NOT NULL COMMENT 'article title',
  `CONTENT` TEXT NOT NULL COMMENT 'article content',
  `USER` INT(11) NOT NULL COMMENT 'user id',
  `CATEGORY` INT(11) NOT NULL COMMENT 'category id',
  `STATUS` VARCHAR(1) NOT NULL COMMENT 'article status: 1draft, 2published',
  `CREATED_WHEN` DATETIME NOT NULL COMMENT 'the time of creating',
  `PUBLISH_TIME` DATETIME NULL COMMENT 'the time of publishing',
  `LAST_MODIFY` DATETIME NULL COMMENT 'this time of last modify',
  PRIMARY KEY (`ID`),
  CONSTRAINT FK_ARTICLE_USER FOREIGN KEY (`USER`) references USER(`ID`)
)
ENGINE = InnoDB
AUTO_INCREMENT = 1
CHARSET = utf8
COMMENT = 'ARTICLE';

DROP TABLE IF EXISTS `ARTICLE_ATTACHMENT`;

CREATE TABLE `ARTICLE_ATTACHMENT` (
  `ID` INT(11) NOT NULL AUTO_INCREMENT COMMENT 'ID',
  `LOCATION` VARCHAR(250) NOT NULL COMMENT 'attachment path',
  `ARTICLE` INT(11) NOT NULL COMMENT 'article id',
  `CREATED_WHEN` DATETIME NOT NULL COMMENT 'the time of creating',
  PRIMARY KEY (`ID`),
  CONSTRAINT FK_ARTICLE_ATTACHMENT_ARTICLE FOREIGN KEY (`ARTICLE`) references ARTICLE(`ID`)
)
ENGINE = InnoDB
AUTO_INCREMENT = 1
CHARSET = utf8
COMMENT = 'ARTICLE_ATTACHMENT';

DROP TABLE IF EXISTS `COMMENT`;

CREATE TABLE `COMMENT` (
  `ID` INT(11) NOT NULL AUTO_INCREMENT COMMENT 'ID',
  `USER` INT(11) NOT NULL COMMENT 'who commit the comment',
  `ARTICLE` INT(11) NOT NULL COMMENT 'article id',
  `PARENT_COMMENT` INT(11) NOT NULL COMMENT 'parent id',
  `CONTENT` VARCHAR(255) NOT NULL COMMENT 'comment content',
  `CREATED_WHEN` DATETIME NOT NULL COMMENT 'the time of creating',
  PRIMARY KEY (`ID`),
  CONSTRAINT FK_COMMENT_USER FOREIGN KEY (`USER`) references USER(`ID`),
  CONSTRAINT FK_COMMENT_ARTICLE FOREIGN KEY (`ARTICLE`) references ARTICLE(`ID`),
  CONSTRAINT FK_PARENT_COMMENT FOREIGN KEY (`PARENT_COMMENT`) references COMMENT(`ID`)
)
ENGINE = InnoDB
AUTO_INCREMENT = 1
CHARSET = utf8
COMMENT = 'COMMENT';

CREATE TABLE `VIEW_HISTORY` (
  `ID` INT(11) NOT NULL AUTO_INCREMENT COMMENT 'ID',
  `USER` INT(11) NOT NULL COMMENT 'who view article',
  `ARTICLE` INT(11) NOT NULL COMMENT 'article id',
  `VIEW_WHEN` DATETIME NOT NULL COMMENT 'the time of viewing',
  `COUNT_RECORD` VARCHAR(2) NULL COMMENT 'Y: a view count record, otherwise N',
  PRIMARY KEY (`ID`),
  CONSTRAINT FK_VIEW_HISTORY_USER FOREIGN KEY (`USER`) references USER(`ID`),
  CONSTRAINT FK_VIEW_HISTORY_ARTICLE FOREIGN KEY (`ARTICLE`) references ARTICLE(`ID`)
)
ENGINE = InnoDB
AUTO_INCREMENT = 1
CHARSET = utf8
COMMENT = 'VIEW_HISTORY';


INSERT INTO ROLE (ID, NAME, DESCRIPTION) VALUES (NULL, 'admin', 'Administrator');
INSERT INTO ROLE (ID, NAME, DESCRIPTION) VALUES (NULL, 'user', 'Normal User');

ALTER TABLE blog.`user` ADD CONSTRAINT user_un UNIQUE KEY (`USER_NAME`);
ALTER TABLE blog.`user` ADD CONSTRAINT user_un_email UNIQUE KEY (`EMAIL`);
